#!/bin/sh

set -x

##################################################################

# dbpurge by Jeff Johnston <jj358mhz@gmail.com>
# Allows schedule purge (delete) from your Dropbox app
# THIS FILE: /usr/local/bin/dbpurge
# No Warranty is implied, promised or permitted.

## Create this folder if it does not exist:
### /etc/dbpurge/

# File Locations for Raspberry Pi (Debian based)
### /usr/local/bin/dbpurge        ( this file )
### /etc/dbpurge/dbpurge.conf     ( configuration file )

# Schedule a cronjob for top and bottom of every hour, everyday
# sudo crontab -e and paste the entry below
# 0,30 * * * *   [ -x /usr/local/bin/dbpurge ] && /usr/local/bin/dbpurge cron > /dev/null

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed

##################################################################

# PATH added in case it is not set when cron runs @reboot
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:

# Make config changes to the following file...
CONFIGFILE=/etc/dbpurge/dbpurge.conf

# Check and load the conf file
[ -f "$CONFIGFILE" ] && . $CONFIGFILE

# Calculates the maximum file count based on number of DAYS (from dbpurge.conf)
FILE_COUNT=$(($DAYS \* 24))

# Fetches the total file count
REMOTE_COUNT=`$DBSCRIPT list | wc -l`

if `[ $REMOTE_COUNT -gt $FILE_COUNT ]`; then
    DBFILE_PURGE=`$DBSCRIPT list | gawk 'NR==2{print $3}'`
    [ $USEDROPBOX = "yes" ] && sudo -u pi $DBSCRIPT delete /"$DBFILE_PURGE"
    echo "A file was purged"
else
    echo "A file was not purged"
fi

exit 0

